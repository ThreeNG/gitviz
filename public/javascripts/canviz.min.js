(function(exports){var debug=exports.debug=function(a,b){a=String(a),"undefined"==typeof b&&(b=!0),b&&(a=a.escapeHTML()),$("debug_output").innerHTML+="&raquo;"+a+"&laquo;<br />"},Point=exports.Point=function(a,b){this.x=a,this.y=b};Point.prototype={constructor:Point,offset:function(a,b){return this.x+=a,this.y+=b,this},distanceFrom:function(a){var b=this.x-a.x,c=this.y-a.y;return Math.sqrt(b*b+c*c)},makePath:function(a){a.moveTo(this.x,this.y),a.lineTo(this.x+.05,this.y)}};var Bezier=exports.Bezier=function(a){this.points=a,this.order=a.length};Bezier.prototype={constructor:Bezier,reset:function(){with(Bezier.prototype)this.controlPolygonLength=controlPolygonLength,this.chordLength=chordLength,this.triangle=triangle,this.chordPoints=chordPoints,this.coefficients=coefficients},offset:function(a,b){var c=this.points.length;for(var d=0;d<c;++d)this.points[d].offset(a,b);return this.reset(),this},getBB:function(){if(!this.order)return undefined;var a,b,c,d,e=this.points[0];a=c=e.x,b=d=e.y;var f=this.points.length;for(var g=1;g<f;++g)e=this.points[g],a=Math.min(a,e.x),b=Math.min(b,e.y),c=Math.max(c,e.x),d=Math.max(d,e.y);var h=new Rect(a,b,c,d);return(this.getBB=function(){return h})()},isPointInBB:function(a,b,c){"undefined"==typeof c&&(c=0);var d=this.getBB();return 0<c&&(d=Object.clone(d),d.inset(-c,-c)),!(a<d.l||a>d.r||b<d.t||b>d.b)},isPointOnBezier:function(a,b,c){"undefined"==typeof c&&(c=0);if(!this.isPointInBB(a,b,c))return!1;var d=this.chordPoints(),e=d.length,f=d[0].p,g,h,i,j,k,l,m,n,o;for(var p=1;p<e;++p){g=d[p].p,h=f.x,i=f.y,j=g.x,k=g.y,l=new Rect(h,i,j,k);if(l.isPointInBB(a,b,c)){m=Math.abs(h*k+j*b+a*i-j*i-a*k-h*b),n=f.distanceFrom(g),o=m/n;if(o<=c)return!0}f=g}return!1},controlPolygonLength:function(){var a=0,b=this.order;for(var c=1;c<b;++c)a+=this.points[c-1].distanceFrom(this.points[c]);return(this.controlPolygonLength=function(){return a})()},chordLength:function(){var a=this.points[0].distanceFrom(this.points[this.order-1]);return(this.chordLength=function(){return a})()},triangle:function(){var a=this.points,b=[a],c=this.order;for(var d=1;d<c;++d){var e=[];for(var f=0;f<c-d;++f){var g=a[f],h=a[f+1];e[f]=new Point((g.x+h.x)/2,(g.y+h.y)/2)}b.push(e),a=e}return(this.triangle=function(){return b})()},triangleAtT:function(a){var b=1-a,c=this.points,d=[c],e=this.order;for(var f=1;f<e;++f){var g=[];for(var h=0;h<e-f;++h){var i=c[h],j=c[h+1];g[h]=new Point(i.x*b+j.x*a,i.y*b+j.y*a)}d.push(g),c=g}return d},split:function(a){"undefined"==typeof a&&(a=.5);var b=.5==a?this.triangle():this.triangleAtT(a),c=this.order,d=[],e=[];for(var f=0;f<c;++f)d[f]=b[f][0],e[f]=b[c-1-f][f];return{left:new Bezier(d),right:new Bezier(e)}},mid:function(a,b){return this.split(b).left.split(a/b).right},chordPoints:function(){var a=[{tStart:0,tEnd:0,dt:0,p:this.points[0]}].concat(this._chordPoints(0,1));return(this.chordPoints=function(){return a})()},_chordPoints:function(a,b){var c=.001,d=b-a;if(this.controlPolygonLength()<=(1+c)*this.chordLength())return[{tStart:a,tEnd:b,dt:d,p:this.points[this.order-1]}];var e=a+d/2,f=this.split();return f.left._chordPoints(a,e).concat(f.right._chordPoints(e,b))},markedEvery:function(a,b){var c=b||a,d=this.chordPoints(),e=d.length,f=[],g=0,h,i,j;for(var k=1;k<e;++k){i=d[k],i.length=i.p.distanceFrom(d[k-1].p);if(0==i.length)g+=i.dt;else{h=c/i.length*i.dt,i.remainingLength=i.length;while(i.remainingLength>=c)i.remainingLength-=c,g+=h,f.push(g),a!=c&&(c=a,h=c/i.length*i.dt);c-=i.remainingLength,g=i.tEnd}}return{times:f,nextDistance:c}},coefficients:function(){function a(a,b){a.push(0);var c=[];c[0]=a[0];var d=b.length;for(var e=0;e<d;++e)c[e+1]=a[e+1]+b[e]-a[e];return c}function b(b){while(b.length>1){var c=b.length-1,d=[];for(var e=0;e<c;++e)d[e]=a(b[e],b[e+1]);b=d}return b[0]}var c=[],d=[];for(var e=0,f;f=this.points[e++];)c.push([f.x]),d.push([f.y]);var g={xs:b(c),ys:b(d)};return(this.coefficients=function(){return g})()},pointAtT:function(a){var b=this.coefficients(),c=b.xs,d=b.ys,e=c[c.length-1],f=d[d.length-1];for(var g=c.length-1;--g>=0;)e=e*a+c[g],f=f*a+d[g];return new Point(e,f)},makePath:function(a,b){"undefined"==typeof b&&(b=!0),b&&a.moveTo(this.points[0].x,this.points[0].y);var c=this.pathCommands[this.order];if(c){var d=[],e=this.points.length;for(var f=1==this.order?0:1;f<e;++f){var g=this.points[f];d.push(g.x),d.push(g.y)}c.apply(a,d)}},pathCommands:[null,function(a,b){this.lineTo(a+.05,b)},function(a,b){this.lineTo(a,b)},function(a,b,c,d){this.quadraticCurveTo(a,b,c,d)},function(a,b,c,d,e,f){this.bezierCurveTo(a,b,c,d,e,f)}],makeDashedPath:function(a,b,c,d){c||(c=b),"undefined"==typeof d&&(d=!0);var e=this.markedEvery(b,c);d&&e.times.unshift(0);var f=e.times.length%2;f&&e.times.push(1);var g=e.times.length;for(var h=1;h<g;h+=2)this.mid(e.times[h-1],e.times[h]).makePath(a);return{firstDistance:e.nextDistance,drawFirst:f}},makeDottedPath:function(a,b,c){c||(c=b);var d=this.markedEvery(b,c);b==c&&d.times.unshift(0);var e=d.times.length;for(var f=0;f<e;++f)this.pointAtT(d.times[f]).makePath(a);return d.nextDistance}};var objectKeys="undefined"!=typeof Object.keys?Object.keys:function(){var a=Object.prototype.hasOwnProperty;return function(b){var c=[];for(var d in b)a.call(b,d)&&c.push(d);return c}}(),Path=exports.Path=function(a,b){this.segments=a||[],this.options={},b&&this.setOptions(b)};Path.prototype={constructor:Path,x_fill:!1,x_stroke:!0,x_strokeType:"solid",x_dashLength:6,x_dotSpacing:4,setOptions:function(a){var b=objectKeys(a),c=b.length;for(var d=0;d<c;++d){var e=b[d];"x_"==e.substr(0,2)?this[e]=a[e]:this.options[e]=a[e]}},setupSegments:function(){},addBezier:function(a){this.segments.push(a instanceof Array?new Bezier(a):a)},offset:function(a,b){0==this.segments.length&&this.setupSegments();var c=this.segments.length;for(var d=0;d<c;++d)this.segments[d].offset(a,b)},getBB:function(){0==this.segments.length&&this.setupSegments();var a,b,c,d,e=this.segments[0].points[0];a=c=e.x,b=d=e.y;var f=this.segments.length;for(var g=0;g<f;++g){var h=this.segments[g].points,i=h.length;for(var j=0;j<i;++j){var k=this.segments[g].points[j];a=Math.min(a,k.x),b=Math.min(b,k.y),c=Math.max(c,k.x),d=Math.max(d,k.y)}}var l=new Rect(a,b,c,d);return(this.getBB=function(){return l})()},isPointInBB:function(a,b,c){"undefined"==typeof c&&(c=0);var d=this.getBB();return 0<c&&(d=Object.clone(d),d.inset(-c,-c)),!(a<d.l||a>d.r||b<d.t||b>d.b)},isPointOnPath:function(a,b,c){"undefined"==typeof c&&(c=0);if(!this.isPointInBB(a,b,c))return!1;var d=this.segments.length;for(var e=0;e<d;++e)if(this.segments[e].isPointOnBezier(a,b,c))return!0;return!1},isPointInPath:function(a,b){return!1},makePath:function(a){0==this.segments.length&&this.setupSegments();var b=this.segments.length;for(var c=0;c<b;++c)this.segments[c].makePath(a,0==c)},makeDashedPath:function(a,b,c,d){0==this.segments.length&&this.setupSegments();var e={drawFirst:"undefined"==typeof d?!0:d,firstDistance:c||b},f=this.segments.length;for(var g=0;g<f;++g)e=this.segments[g].makeDashedPath(a,b,e.firstDistance,e.drawFirst)},makeDottedPath:function(a,b,c){0==this.segments.length&&this.setupSegments(),c||(c=b);var d=this.segments.length;for(var e=0;e<d;++e)c=this.segments[e].makeDottedPath(a,b,c)},draw:function(a){a.save();var b=objectKeys(this.options),c=b.length;for(var d=0;d<c;++d){var e=b[d];a[e]=this.options[e]}this.x_fill&&(a.beginPath(),this.makePath(a),a.fill());if(this.x_stroke){switch(this.x_strokeType){case"dashed":a.beginPath(),this.makeDashedPath(a,this.x_dashLength);break;case"dotted":a.lineWidth<2&&(a.lineWidth=2),a.beginPath(),this.makeDottedPath(a,this.x_dotSpacing);break;case"solid":default:this.x_fill||(a.beginPath(),this.makePath(a))}a.stroke()}a.restore()}};var Polygon=exports.Polygon=function(a,b){this.points=a||[],Path.call(this,[],b)};Polygon.prototype=new Path,Polygon.prototype.constructor=Polygon,Polygon.prototype.offset=function(a,b){var c=this.points.length;for(var d=0;d<c;++d)this.points[d].offset(a,b);return this},Polygon.prototype.setupSegments=function(){var a=this.points.length;for(var b=0;b<a;++b){var c=b+1;this.points.length==c&&(c=0),this.addBezier([this.points[b],this.points[c]])}};var Rect=exports.Rect=function(a,b,c,d,e){this.l=a,this.t=b,this.r=c,this.b=d,Polygon.call(this,[],e)};Rect.prototype=new Polygon,Rect.prototype.constructor=Rect,Rect.prototype.offset=function(a,b){return this.l+=a,this.t+=b,this.r+=a,this.b+=b,this},Rect.prototype.inset=function(a,b){return this.l+=a,this.t+=b,this.r-=a,this.b-=b,this},Rect.prototype.expandToInclude=function(a){this.l=Math.min(this.l,a.l),this.t=Math.min(this.t,a.t),this.r=Math.max(this.r,a.r),this.b=Math.max(this.b,a.b)},Rect.prototype.getWidth=function(){return this.r-this.l},Rect.prototype.getHeight=function(){return this.b-this.t},Rect.prototype.setupSegments=function(){var a=this.getWidth(),b=this.getHeight();this.points=[new Point(this.l,this.t),new Point(this.l+a,this.t),new Point(this.l+a,this.t+b),new Point(this.l,this.t+b)],Polygon.prototype.setupSegments.call(this)};var CanvizImage=exports.CanvizImage=Class.create({initialize:function(a,b){this.canviz=a,++this.canviz.numImages,this.finished=this.loaded=!1,this.img=new Image,this.img.onload=this.onLoad.bind(this),this.img.onerror=this.onFinish.bind(this),this.img.onabort=this.onFinish.bind(this),this.img.src=this.canviz.imagePath+b},onLoad:function(){this.loaded=!0,this.onFinish()},onFinish:function(){this.finished=!0,++this.canviz.numImagesFinished,this.canviz.numImages==this.canviz.numImagesFinished&&this.canviz.draw(!0)},draw:function(a,b,c,d,e){this.finished&&(this.loaded?a.drawImage(this.img,b,c,d,e):(debug("can't load image "+this.img.src),this.drawBrokenImage(a,b,c,d,e)))},drawBrokenImage:function(a,b,c,d,e){a.save(),a.beginPath(),(new Rect(b,c,b+d,c+d)).draw(a),a.moveTo(b,c),a.lineTo(b+d,c+d),a.moveTo(b+d,c),a.lineTo(b,c+e),a.strokeStyle="#f00",a.lineWidth=1,a.stroke(),a.restore()}}),Ellipse=exports.Ellipse=function(a,b,c,d,e){this.cx=a,this.cy=b,this.rx=c,this.ry=d,Path.call(this,[],e)};Ellipse.prototype=new Path,Ellipse.prototype.constructor=Ellipse,Ellipse.prototype.offset=function(a,b){return this.cx+=a,this.cy+=b,this};var KAPPA=.5522847498;Ellipse.prototype.setupSegments=function(){this.addBezier([new Point(this.cx,this.cy-this.ry),new Point(this.cx+KAPPA*this.rx,this.cy-this.ry),new Point(this.cx+this.rx,this.cy-KAPPA*this.ry),new Point(this.cx+this.rx,this.cy)]),this.addBezier([new Point(this.cx+this.rx,this.cy),new Point(this.cx+this.rx,this.cy+KAPPA*this.ry),new Point(this.cx+KAPPA*this.rx,this.cy+this.ry),new Point(this.cx,this.cy+this.ry)]),this.addBezier([new Point(this.cx,this.cy+this.ry),new Point(this.cx-KAPPA*this.rx,this.cy+this.ry),new Point(this.cx-this.rx,this.cy+KAPPA*this.ry),new Point(this.cx-this.rx,this.cy)]),this.addBezier([new Point(this.cx-this.rx,this.cy),new Point(this.cx-this.rx,this.cy-KAPPA*this.ry),new Point(this.cx-KAPPA*this.rx,this.cy-this.ry),new Point(this.cx,this.cy-this.ry)])};var CanvizTokenizer=exports.CanvizTokenizer=Class.create({initialize:function(a){this.str=a},takeChars:function(a){a||(a=1);var b=new Array;while(a--){var c=this.str.match(/^(\S+)\s*/);c?(this.str=this.str.substr(c[0].length),b.push(c[1])):b.push(!1)}return 1==b.length?b[0]:b},takeNumber:function(a){a||(a=1);if(1==a)return Number(this.takeChars());var b=this.takeChars(a);while(a--)b[a]=Number(b[a]);return b},takeString:function(){var a=Number(this.takeChars()),b=0,c;if("-"!=this.str.charAt(0))return!1;while(0<a)++b,c=this.str.charCodeAt(b),128>c?--a:2048>c?a-=2:a-=3;var d=this.str.substr(1,b);return this.str=this.str.substr(1+b).replace(/^\s+/,""),d}}),CanvizEntity=exports.CanvizEntity=Class.create({initialize:function(a,b,c,d,e,f){this.defaultAttrHashName=a,this.name=b,this.canviz=c,this.rootGraph=d,this.parentGraph=e,this.immediateGraph=f,this.attrs=$H(),this.drawAttrs=$H()},initBB:function(){var a=this.getAttr("pos").match(/([0-9.]+),([0-9.]+)/),b=Math.round(a[1]),c=Math.round(this.canviz.height-a[2]);this.bbRect=new Rect(b,c,b,c)},getAttr:function(a,b){"undefined"==typeof b&&(b=!1);var c=this.attrs.get(a);if("undefined"==typeof c){var d=this.parentGraph;while("undefined"!=typeof d){c=d[this.defaultAttrHashName].get(a);if("undefined"!=typeof c)break;d=d.parentGraph}}return c&&b&&(c=c.replace(this.escStringMatchRe,function(a,b){switch(b){case"N":case"E":return this.name;case"T":return this.tailNode;case"H":return this.headNode;case"G":return this.immediateGraph.name;case"L":return this.getAttr("label",!0)}return a}.bind(this))),c},draw:function(a,b,c){var d,e,f,g;if(!c){this.initBB();var h=new Element("div");this.canviz.elements.appendChild(h)}this.drawAttrs.each(function(j){var k=j.value,l=new CanvizTokenizer(k),m=l.takeChars();if(m){var n="solid";a.save();while(m){switch(m){case"E":case"e":var o="E"==m,p=l.takeNumber(),q=this.canviz.height-l.takeNumber(),r=l.takeNumber(),s=l.takeNumber(),t=new Ellipse(p,q,r,s);break;case"P":case"p":case"L":var o="P"==m,u="L"!=m,v=l.takeNumber();e=l.takeNumber(2*v);var t=new Path;for(d=2;d<2*v;d+=2)t.addBezier([new Point(e[d-2],this.canviz.height-e[d-1]),new Point(e[d],this.canviz.height-e[d+1])]);u&&t.addBezier([new Point(e[2*v-2],this.canviz.height-e[2*v-1]),new Point(e[0],this.canviz.height-e[1])]);break;case"B":case"b":var o="b"==m,v=l.takeNumber();e=l.takeNumber(2*v);var t=new Path;for(d=2;d<2*v;d+=6)t.addBezier([new Point(e[d-2],this.canviz.height-e[d-1]),new Point(e[d],this.canviz.height-e[d+1]),new Point(e[d+2],this.canviz.height-e[d+3]),new Point(e[d+4],this.canviz.height-e[d+5])]);break;case"I":var w=l.takeNumber(),x=this.canviz.height-l.takeNumber(),y=l.takeNumber(),z=l.takeNumber(),A=l.takeString();this.canviz.images[A]||(this.canviz.images[A]=new CanvizImage(this.canviz,A)),this.canviz.images[A].draw(a,w,x-z,y,z);break;case"T":var w=Math.round(b*l.takeNumber()+this.canviz.padding),B=Math.round(b*this.canviz.height+2*this.canviz.padding-(b*(l.takeNumber()+this.canviz.bbScale*fontSize)+this.canviz.padding)),C=l.takeNumber(),D=Math.round(b*l.takeNumber()),E=l.takeString();if(!c&&!/^\s*$/.test(E)){E=E.escapeHTML();do{matches=E.match(/ ( +)/);if(matches){var F=" ";matches[1].length.times(function(){F+="&nbsp;"}),E=E.replace(/  +/,F)}}while(matches);var G,H=this.getAttr("URL",!0)||this.getAttr("href",!0);if(H){var I=this.getAttr("target",!0)||"_self",J=this.getAttr("tooltip",!0)||this.getAttr("label",!0);G=new Element("a",{href:H,target:I,title:J}),["onclick","onmousedown","onmouseup","onmouseover","onmousemove","onmouseout"].each(function(a){var b=this.getAttr(a,!0);b&&G.writeAttribute(a,b)}.bind(this)),G.setStyle({textDecoration:"none"})}else G=new Element("span");G.update(E),G.setStyle({fontSize:Math.round(fontSize*b*this.canviz.bbScale)+"px",fontFamily:fontFamily,color:g.textColor,position:"absolute",textAlign:-1==C?"left":1==C?"right":"center",left:w-(1+C)*D+"px",top:B+"px",width:2*D+"px"}),1!=g.opacity&&G.setOpacity(g.opacity),this.canviz.elements.appendChild(G)}break;case"C":case"c":var K="C"==m,L=this.parseColor(l.takeString());K?(f=L,a.fillStyle=L.canvasColor):(g=L,a.strokeStyle=L.canvasColor);break;case"F":fontSize=l.takeNumber(),fontFamily=l.takeString();switch(fontFamily){case"Times-Roman":fontFamily="Times New Roman";break;case"Courier":fontFamily="Courier New";break;case"Helvetica":fontFamily="Arial";break;default:}break;case"S":var M=l.takeString();switch(M){case"solid":case"filled":break;case"dashed":case"dotted":n=M;break;case"bold":a.lineWidth=2;break;default:matches=M.match(/^setlinewidth\((.*)\)$/),matches?a.lineWidth=Number(matches[1]):debug("unknown style "+M)}break;default:debug("unknown token "+m);return}t&&(this.canviz.drawPath(a,t,o,n),c||this.bbRect.expandToInclude(t.getBB()),t=undefined),m=l.takeChars()}c||h.setStyle({position:"absolute",left:Math.round(b*this.bbRect.l+this.canviz.padding)+"px",top:Math.round(b*this.bbRect.t+this.canviz.padding)+"px",width:Math.round(b*this.bbRect.getWidth())+"px",height:Math.round(b*this.bbRect.getHeight())+"px"}),a.restore()}}.bind(this))},parseColor:function(a){var b={opacity:1};if(/^#(?:[0-9a-f]{2}\s*){3,4}$/i.test(a))return this.canviz.parseHexColor(a);var c=a.match(/^(\d+(?:\.\d+)?)[\s,]+(\d+(?:\.\d+)?)[\s,]+(\d+(?:\.\d+)?)$/);if(c)return b.canvasColor=b.textColor=this.canviz.hsvToRgbColor(c[1],c[2],c[3]),b;var d=this.getAttr("colorscheme")||"X11",e=a;c=a.match(/^\/(.*)\/(.*)$/),c?(c[1]&&(d=c[1]),e=c[2]):(c=a.match(/^\/(.*)$/),c&&(d="X11",e=c[1])),e=e.toLowerCase();var f=d.toLowerCase(),g=Canviz.prototype.colors.get(f);if(g){var h=g[e];if(h)return this.canviz.parseHexColor("#"+h)}return h=Canviz.prototype.colors.get("fallback")[e],h?this.canviz.parseHexColor("#"+h):(g||debug("unknown color scheme "+d),debug("unknown color "+a+"; color scheme is "+d),b.canvasColor=b.textColor="#000000",b)}}),CanvizEdge=exports.CanvizEdge=Class.create(CanvizEntity,{initialize:function($super,a,b,c,d,e,f){$super("edgeAttrs",a,b,c,d,d),this.tailNode=e,this.headNode=f}});Object.extend(CanvizEdge.prototype,{escStringMatchRe:/\\([EGTHL])/g});var CanvizGraph=exports.CanvizGraph=Class.create(CanvizEntity,{initialize:function($super,a,b,c,d){$super("attrs",a,b,c,d,this),this.nodeAttrs=$H(),this.edgeAttrs=$H(),this.nodes=$A(),this.edges=$A(),this.subgraphs=$A()},initBB:function(){var a=this.getAttr("bb").split(",");this.bbRect=new Rect(a[0],this.canviz.height-a[1],a[2],this.canviz.height-a[3])},draw:function($super,a,b,c){$super(a,b,c),[this.subgraphs,this.nodes,this.edges].each(function(d){d.each(function(d){d.draw(a,b,c)})})}});Object.extend(CanvizGraph.prototype,{escStringMatchRe:/\\([GL])/g});var CanvizNode=exports.CanvizNode=Class.create(CanvizEntity,{initialize:function($super,a,b,c,d){$super("nodeAttrs",a,b,c,d,d)}});Object.extend(CanvizNode.prototype,{escStringMatchRe:/\\([NGL])/g});var Canviz=exports.Canviz=Class.create({maxXdotVersion:"1.2",colors:$H({fallback:{black:"000000",lightgrey:"d3d3d3",white:"ffffff"}}),initialize:function(a,b,c){this.canvas=document.createElement("canvas"),Element.setStyle(this.canvas,{position:"absolute"}),Canviz.canvasCounter||(Canviz.canvasCounter=0),this.canvas.id="canviz_canvas_"+ ++Canviz.canvasCounter,this.elements=new Element("div"),this.elements.setStyle({position:"absolute"}),this.container=$(a),this.container.setStyle({position:"relative"}),this.container.appendChild(this.canvas),Prototype.Browser.IE&&(G_vmlCanvasManager.initElement(this.canvas),this.canvas=$(this.canvas.id)),this.container.appendChild(this.elements),this.ctx=this.canvas.getContext("2d"),this.scale=1,this.padding=8,this.dashLength=6,this.dotSpacing=4,this.graphs=$A(),this.images=new Hash,this.numImages=0,this.numImagesFinished=0,b&&this.load(b,c)},setScale:function(a){this.scale=a},setImagePath:function(a){this.imagePath=a},load:function(a,b){$("debug_output").innerHTML="",new Ajax.Request(a,{method:"get",parameters:b,onComplete:function(a){this.parse(a.responseText)}.bind(this)})},parse:function(a){this.graphs=$A(),this.width=0,this.height=0,this.maxWidth=!1,this.maxHeight=!1,this.bbEnlarge=!1,this.bbScale=1,this.dpi=96,this.bgcolor={opacity:1},this.bgcolor.canvasColor=this.bgcolor.textColor="#ffffff";var b=a.split(/\r?\n/),c=0,d,e,f,g,h,i,j,k,l,m,n,o,p=$A();while(c<b.length){d=b[c++].replace(/^\s+/,"");if(""!=d&&"#"!=d.substr(0,1)){while(c<b.length&&";"!=(e=d.substr(d.length-1,d.length))&&"{"!=e&&"}"!=e)"\\"==e&&(d=d.substr(0,d.length-1)),d+=b[c++];0==p.length?(f=d.match(this.graphMatchRe),f&&(g=new CanvizGraph(f[3],this),p.unshift(g),p[0].strict="undefined"!=typeof f[1],p[0].type="graph"==f[2]?"undirected":"directed",p[0].attrs.set("xdotversion","1.0"),this.graphs.push(p[0]))):(f=d.match(this.subgraphMatchRe),f&&(p.unshift(new CanvizGraph(f[1],this,g,p[0])),p[1].subgraphs.push(p[0])));if(!f)if("}"==d){p.shift();if(0==p.length)break}else{f=d.match(this.nodeMatchRe);if(f){j=f[2],k=f[5],o=p[0].drawAttrs,h=!1;switch(j){case"graph":n=p[0].attrs,h=!0;break;case"node":n=p[0].nodeAttrs;break;case"edge":n=p[0].edgeAttrs;break;default:i=new CanvizNode(j,this,g,p[0]),n=i.attrs,o=i.drawAttrs,p[0].nodes.push(i)}}else f=d.match(this.edgeMatchRe),f&&(j=f[1],k=f[8],i=new CanvizEdge(j,this,g,p[0],f[2],f[5]),n=i.attrs,o=i.drawAttrs,p[0].edges.push(i));if(f)do{if(0==k.length)break;f=k.match(this.attrMatchRe);if(f){k=k.substr(f[0].length),l=f[1],m=this.unescape(f[2]),/^_.*draw_$/.test(l)?o.set(l,m):n.set(l,m);if(h&&1==p.length)switch(l){case"bb":var q=m.split(/,/);this.width=Number(q[2]),this.height=Number(q[3]);break;case"bgcolor":this.bgcolor=g.parseColor(m);break;case"dpi":this.dpi=m;break;case"size":var r=m.match(/^(\d+|\d*(?:\.\d+)),\s*(\d+|\d*(?:\.\d+))(!?)$/);r?(this.maxWidth=72*Number(r[1]),this.maxHeight=72*Number(r[2]),this.bbEnlarge="!"==r[3]):debug("can't parse size");break;case"xdotversion":0>this.versionCompare(this.maxXdotVersion,n.get("xdotversion"))&&debug("unsupported xdotversion "+n.get("xdotversion")+"; this script currently supports up to xdotversion "+this.maxXdotVersion)}}else debug("can't read attributes for entity "+j+" from "+k)}while(f)}}}this.draw()},draw:function(a){"undefined"==typeof a&&(a=!1);var b=this.scale*this.dpi/72,c=Math.round(b*this.width+2*this.padding),d=Math.round(b*this.height+2*this.padding);if(!a){this.canvas.width=c,this.canvas.height=d,this.canvas.setStyle({width:c+"px",height:d+"px"}),this.container.setStyle({width:c+"px",height:d+"px"});while(this.elements.firstChild)this.elements.removeChild(this.elements.firstChild)}this.ctx.save(),this.ctx.lineCap="round",this.ctx.fillStyle=this.bgcolor.canvasColor,this.ctx.fillRect(0,0,c,d),this.ctx.translate(this.padding,this.padding),this.ctx.scale(b,b),this.graphs[0].draw(this.ctx,b,a),this.ctx.restore()},drawPath:function(a,b,c,d){c&&(a.beginPath(),b.makePath(a),a.fill());if(a.fillStyle!=a.strokeStyle||!c){switch(d){case"dashed":a.beginPath(),b.makeDashedPath(a,this.dashLength);break;case"dotted":var e=a.lineWidth;a.lineWidth*=2,a.beginPath(),b.makeDottedPath(a,this.dotSpacing);break;case"solid":default:c||(a.beginPath(),b.makePath(a))}a.stroke(),e&&(a.lineWidth=e)}},unescape:function(a){var b=a.match(/^"(.*)"$/);return b?b[1].replace(/\\"/g,'"'):a},parseHexColor:function(a){var b=a.match(/^#([0-9a-f]{2})\s*([0-9a-f]{2})\s*([0-9a-f]{2})\s*([0-9a-f]{2})?$/i);if(b){var c,d="#"+b[1]+b[2]+b[3],e=1;b[4]?(e=parseInt(b[4],16)/255,c="rgba("+parseInt(b[1],16)+","+parseInt(b[2],16)+","+parseInt(b[3],16)+","+e+")"):c=d}return{canvasColor:c,textColor:d,opacity:e}},hsvToRgbColor:function(a,b,c){var d,e,f,g,h,i,j,k;a*=360,d=Math.floor(a/60)%6,e=a/60-d,f=c*(1-b),g=c*(1-e*b),h=c*(1-(1-e)*b);switch(d){case 0:i=c,j=h,k=f;break;case 1:i=g,j=c,k=f;break;case 2:i=f,j=c,k=h;break;case 3:i=f,j=g,k=c;break;case 4:i=h,j=f,k=c;break;case 5:i=c,j=f,k=g}return"rgb("+Math.round(255*i)+","+Math.round(255*j)+","+Math.round(255*k)+")"},addColors:function(a){Canviz.prototype.colors.update(a)},versionCompare:function(a,b){a=a.split("."),b=b.split(".");var c,d;while(a.length||b.length){c=a.length?a.shift():0,d=b.length?b.shift():0;if(c<d)return-1;if(c>d)return 1}return 0},idMatch:'([a-zA-Z\u0080-\uffff_][0-9a-zA-Z\u0080-\uffff_]*|-?(?:\\.\\d+|\\d+(?:\\.\\d*)?)|"(?:\\\\"|[^"])*"|<(?:<[^>]*>|[^<>]+?)+>)'});Object.extend(Canviz.prototype,{nodeIdMatch:Canviz.prototype.idMatch+"(?::"+Canviz.prototype.idMatch+")?(?::"+Canviz.prototype.idMatch+")?"}),Object.extend(Canviz.prototype,{graphMatchRe:new RegExp("^(strict\\s+)?(graph|digraph)(?:\\s+"+Canviz.prototype.idMatch+")?\\s*{$","i"),subgraphMatchRe:new RegExp("^(?:subgraph\\s+)?"+Canviz.prototype.idMatch+"?\\s*{$","i"),nodeMatchRe:new RegExp("^("+Canviz.prototype.nodeIdMatch+")\\s+\\[(.+)\\];$"),edgeMatchRe:new RegExp("^("+Canviz.prototype.nodeIdMatch+"\\s*-[->]\\s*"+Canviz.prototype.nodeIdMatch+")\\s+\\[(.+)\\];$"),attrMatchRe:new RegExp("^"+Canviz.prototype.idMatch+"="+Canviz.prototype.idMatch+"(?:[,\\s]+|$)")})})("undefined"!=typeof exports?exports:window)